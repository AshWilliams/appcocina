@using System.Data
@{
    ViewBag.Title = "Home Page";

    DataTable Ingredientes = ViewBag.Ingredientes as DataTable;
    DataTable Platillos = ViewBag.Platillos as DataTable;
}

<style>
    .jumbotron {
        background: url("/Content/CheersBar-Food-76.jpg") center center / cover no-repeat;
    }

        .jumbotron h1, .jumbotron .h1 {
            color: #fcf8e3;
        }
</style>
<div class="jumbotron">
    <h1>App Selección de Platillos Cocina</h1>
</div>

<div class="row">
    <div class="col-md-6">
        <h2>Elegit Platillo</h2>
        <p>
            Presione el siguiente enlace para elegir algunode nuestros platillos.
        </p>
        <p>
            <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
                Elegir Platillo
            </button>
        </p>
    </div>
    <!-- Button trigger modal -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            @Html.AntiForgeryToken()
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Seleccione el Platillo</h4>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="exampleInputEmail1">Platillo</label>
                            <select class="form-control" id="selPlatillos">
                                <option>Seleccione</option>
                                @foreach (System.Data.DataRow item in Platillos.Rows)
                                {
                                    <option value="@item["idPlatillo"].ToString()">@item["nombre"].ToString()</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exampleInputEmail1">Lista de Ingredientes(se restará cantidad al stock al guardar)</label>
                            <ul class="list-group" id="ingredientes"></ul>
                        </div>
                        <div class="form-group">
                            <label for="exampleInputEmail1">Ingredientes</label>
                            <select class="form-control" id="selIngredientes">
                                <option>Seleccione</option>
                                @foreach (System.Data.DataRow item in Ingredientes.Rows)
                                {
                                    <option value="@item["idIngrediente"].ToString()">@item["nombre"].ToString() - @item["Cantidad"].ToString() en Stock</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-success" id="addIngrediente">Agregar Ingredientes</button>
                        </div>
                        <script type="text/javascript">
                            $(function () {

                                $('#myModal').on('hidden.bs.modal', function (e) {
                                    $("#ingredientes").html("");
                                });

                                $("#addIngrediente").click(function () {
                                    let selIngredientes = $("#selIngredientes").find(":selected").text();
                                    let idIngrediente = $("#selIngredientes").val();

                                    $("#ingredientes").append('<li class="list-group-item" data-id="' + idIngrediente + '">'
                                        + '<span class="badge">Cantidad 1</span>'
                                        + selIngredientes.split('-')[0]
                                        + '</li>');
                                });

                                $("#btnGuardar").click(function () {
                                    let lista = $("#ingredientes > li");
                                    let ids = [];
                                    for (let i = 0; i < lista.length; i++) {
                                        ids[i] = ($(lista[i]).data("id"));
                                    }
                                    
                                    $.ajax({
                                        url: "Home/updateStock",
                                        method: "POST",
                                        data: {
                                            ingredientes: ids.join(','),
                                            __RequestVerificationToken: $('[name="__RequestVerificationToken"]').val()
                                        }
                                    }).done(function (response) {
                                        if (response) {
                                            Swal.fire('Se actualizaron los ingredientes en stock de forma correcta')
                                        } else {
                                            Swal.fire('Algo no funcionó, favor contacte al administrador')
                                        }
                                        setTimeout(function () {
                                          $('#myModal').modal('hide');
                                          location.reload();
                                        }, 3000);
                                        
                                    });

                                });

                            });
                        </script>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardar">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>
</div>

